{{ define "main" }}

{{/* minimize js if production; adapted from https://github.com/gohugoio/hugo/issues/9132 */}}
{{ $params := (dict "is_production" hugo.IsProduction ) }}
{{ $sourceMap := cond hugo.IsProduction "" "inline" }}
{{ $buildOptions := dict "sourceMap" $sourceMap "minify" hugo.IsProduction "target" "es2018" "params" $params }}
{{ $js := resources.Get "js/main.js" | js.Build $buildOptions | fingerprint }}

<aside>
  <button class="close" aria-label="close details"><i class="ph-x" aria-hidden="true"></i></button>
  <div class="tag" id="current-tag" aria-label="active tag">
   {{/* display currently active tag when there is one */}}
    <button class="close" aria-label="close active tag"><i class="ph-x" aria-hidden="true"></i></button>
    <span></span> {{/* label for active tag */}}
  </div>
  {{/* introduction content */}}
  <article id="intro">
    <header>
      <h1>{{ .Params.Title }}</h1>
    </header>
    <div>
      {{- .Content -}}
    </div>

    {{/* display legend listing each branch; names from site config */}}
    <ol id="panel-legend">
      {{- range .Site.Params.branches -}}
        {{- $branchSlug := replace (replace .  "The" "") "+" "" | urlize -}}
      <li class="{{ $branchSlug }}"><a href="#{{ $branchSlug }}">{{ . }}</a></li>
      {{- end -}}
    </div>

  </article>

  <div id="leaf-details">
    <article/>
  </div>
</aside>

<div id="timetree">
  <button class="reset-zoom" aria-label="reset zoom to default"><i class="ph-arrows-in ph-fill" aria-hidden="true"></i></button>
  <data class="leaf-data" value='{{ partial "leaf_data.json" . }}'></data>
  <data class="tag-data" value='{{ partial "tags.json" . }}'></data>
  <data class="env-data" value="{{ dict "env" hugo.Environment "branches" .Site.Params.branches "visual_debug" .Site.Params.visual_debug | jsonify }}"/>
</div>


<div class="extras">
<article id="leaferror">
  <div>Error loading the details.</div>
</article>

<div id="a11y-descriptions">
  {{/* provide short screenreader descriptions for leaves in the timetree, to parallel info provided visually by century axis and branch color/position */}}
  {{ range where .Site.Pages "Section" "leaves" }}
  <p id="desc-{{ .RelPermalink | path.Base  }}">{{ with .Params.display_date }}<time>{{ . }}</time>,{{ end }} {{ .Params.branch }}</p>
  {{ end }}
</div>

</div>

{{/* include visual debug controls if enabled in hugo site param */}}
{{ if .Site.Params.visual_debug }}
<div id="debug-controls">
<h2>Visual debug</h2>

<p>Control layer visibility (0 - 100%)</p>

<div>
  <label>Debug
  <input type="range" id="debug-visible" name="debug-visible"
         min="0" max="100" value="0">
  </label>
  <label>Leaves
  <input type="range" id="leaf-visible" name="leaf-visible"
         min="0" max="100" value="100">
  </label>
  <label>Labels
  <input type="range" id="label-visible" name="label-visible"
         min="0" max="100" value="100">
  </label>
</div>
{{ end }}

<script src="{{ $js.RelPermalink }}" integrity="{{ $js.Data.Integrity }}" defer></script>
{{ end }} {{/* end main */}}